---
title: 高性能MySQL(第3版)第六章-查询性能优化
date: 2017-06-01 14:19:08
tags:
- mysql
categories:
- 读书笔记
description: 高性能MySQL(第3版)第六章-查询性能优化
---

# 慢查询基础：优化数据访问
大部分性能低下的查询都可以通过减少访问的数据量的方式进行优化。对于低效的查询，通过下面两个步骤来分析总是很有效：

1. 确认应用程序是否在检索大量超过需要的数据。访问太多和行或列。
2. 确认Mysql服务器

## 是否向数据库请求了不需要的数据
这里有些典型案例：

* 查询不需要的记录：先使用SELECT语句查询大量结果，然后获取前面的N行后关闭结果集
* 多表关联时返回全部列：多表关联时不要``SELECT *``，否则会返回所有关联的表的列
* 重复查询相同的数据：这时应该用缓存

## 是否在扫描额外的记录
对于mysql，最简单的衡量查询开销的三个指标如下：

* 响应时间：服务时间+排队时间。
* 扫描的行数
* 返回的行数

### 扫描的行数和访问类型
访问类型从慢到快有很多种：全表扫描、索引扫描、范围扫描、唯一索引查询、常数引用等。

一般Mysql能够使用如下三种方式应用WHERE条件，从好到坏依次为：

* 在索引中使用WHERE条件来过滤不匹配的记录。这是在存储引擎层完成的。
* 使用索引覆盖扫描（在Extra列中出现了Using index）来返回记录，直接从索引中过滤不需要的记录并返回命中的结果。这是在服务器层完成的，无须再回表查询记录。
* 从数据表中返回数据，然后过滤掉不满足条件的记录（在Extra列中出现Using Where）。这在服务器层完成，需要从数据表中读出记录然后过滤。

如果发现查询需要扫描大量的数据但只返回少数的行，那么可以尝试下面的技巧去优化：

* 使用索引覆盖扫描
* 改变库表结构
* 重写查询

# 重构查询的方式
## 一个复杂查询还是多个简单查询
在传统的实现中，总是强调需要数据库层完成尽可能多的工作。但是对mysql并不适用，mysql从设计上让连接和断开都很轻量级，在返回一个小的查询结果方面很高效。

## 切分查询
比如可以将下面这条语句进行切分：

```sql
DELETE FROM messages WHERE created < DATE_SUB(NOW(), INTERVAL 3 MONTH);
```

改写后为：

```sql
rows_affected = 0
do {
	rows_affected = do_query (
		"DELETE FROM messages WHERE created < DATE_SUB(NOW(), INTERVAL 3 MONTH) LIMIT 10000"	
	)
} while rows_affected > 0
```

## 分解关联查询